---
name: Test Action

on:
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 24

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm test

  test-basic:
    name: Test basic usage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create output directory
        run: mkdir -p ./test-output

      - name: Generate README
        id: generate
        uses: ./
        with:
          output-path: ./test-output/basic.md

      - name: Validate output exists
        run: |
          if [[ ! -f "./test-output/basic.md" ]]; then
            echo "::error::Output file not created"
            exit 1
          fi

      - name: Validate sections present
        run: |
          file="./test-output/basic.md"

          # Check for expected sections
          if ! grep -q "^# Action Docs Generator" "$file"; then
            echo "::error::Missing title"
            exit 1
          fi

          if ! grep -q "^## Requirements" "$file"; then
            echo "::error::Missing requirements"
            exit 1
          fi

          if ! grep -q "^## Inputs" "$file"; then
            echo "::error::Missing inputs"
            exit 1
          fi

          if ! grep -q "^## Outputs" "$file"; then
            echo "::error::Missing outputs"
            exit 1
          fi

          if ! grep -q "^## Usage" "$file"; then
            echo "::error::Missing usage"
            exit 1
          fi

          if ! grep -q "^## License" "$file"; then
            echo "::error::Missing license"
            exit 1
          fi

          echo "All expected sections present"

      - name: Validate outputs set
        env:
          README_PATH: ${{ steps.generate.outputs.readme-path }}
          SECTIONS_GENERATED: ${{ steps.generate.outputs.sections-generated }}
        run: |
          echo "readme-path: $README_PATH"
          echo "sections-generated: $SECTIONS_GENERATED"

          if [[ -z "$README_PATH" ]]; then
            echo "::error::readme-path output not set"
            exit 1
          fi

          if [[ -z "$SECTIONS_GENERATED" ]]; then
            echo "::error::sections-generated output not set"
            exit 1
          fi

  test-exclude-sections:
    name: Test excluding sections
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create output directory
        run: mkdir -p ./test-output

      - name: Generate README without examples and contributing
        id: generate
        uses: ./
        with:
          output-path: ./test-output/excluded.md
          exclude-sections: examples,contributing,permissions

      - name: Validate excluded sections are missing
        run: |
          file="./test-output/excluded.md"

          # These sections should NOT be present
          if grep -q "^## Examples" "$file"; then
            echo "::error::Examples section should be excluded"
            exit 1
          fi

          if grep -q "^## Contributing" "$file"; then
            echo "::error::Contributing section should be excluded"
            exit 1
          fi

          if grep -q "^## Permissions" "$file"; then
            echo "::error::Permissions section should be excluded"
            exit 1
          fi

          # These sections SHOULD be present
          if ! grep -q "^## Inputs" "$file"; then
            echo "::error::Missing inputs"
            exit 1
          fi

          if ! grep -q "^## Usage" "$file"; then
            echo "::error::Missing usage"
            exit 1
          fi

          echo "Section exclusion working correctly"

  test-include-sections:
    name: Test including only specific sections
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create output directory
        run: mkdir -p ./test-output

      - name: Generate README with only title, inputs, and usage
        id: generate
        uses: ./
        with:
          output-path: ./test-output/included.md
          include-sections: title,inputs,usage

      - name: Validate only included sections present
        run: |
          file="./test-output/included.md"

          # These sections SHOULD be present
          if ! grep -q "^# Action Docs Generator" "$file"; then
            echo "::error::Missing title"
            exit 1
          fi

          if ! grep -q "^## Inputs" "$file"; then
            echo "::error::Missing inputs"
            exit 1
          fi

          if ! grep -q "^## Usage" "$file"; then
            echo "::error::Missing usage"
            exit 1
          fi

          # These sections should NOT be present
          if grep -q "^## Outputs" "$file"; then
            echo "::error::Outputs section should not be included"
            exit 1
          fi

          if grep -q "^## License" "$file"; then
            echo "::error::License section should not be included"
            exit 1
          fi

          echo "Section inclusion working correctly"

  test-custom-license:
    name: Test custom license
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create output directory
        run: mkdir -p ./test-output

      - name: Generate README with Apache license
        uses: ./
        with:
          output-path: ./test-output/apache.md
          license: Apache-2.0

      - name: Validate license text
        run: |
          file="./test-output/apache.md"

          if ! grep -q "Apache-2.0 License" "$file"; then
            echo "::error::License not set correctly"
            exit 1
          fi

          echo "Custom license working correctly"

  test-badges:
    name: Test badge generation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create output directory
        run: mkdir -p ./test-output

      - name: Generate README with badges
        uses: ./
        with:
          output-path: ./test-output/badges.md
          badges: |
            [
              {"label": "build", "message": "passing", "color": "green"},
              {"label": "coverage", "message": "90%", "color": "brightgreen", "url": "https://codecov.io"}
            ]

      - name: Validate badges present
        run: |
          file="./test-output/badges.md"

          if ! grep -q "img.shields.io/badge" "$file"; then
            echo "::error::Badge not generated"
            exit 1
          fi

          if ! grep -q "build" "$file"; then
            echo "::error::Build badge not found"
            exit 1
          fi

          if ! grep -q "coverage" "$file"; then
            echo "::error::Coverage badge not found"
            exit 1
          fi

          echo "Badge generation working correctly"

  test-header-level:
    name: Test custom header level
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create output directory
        run: mkdir -p ./test-output

      - name: Generate README with header level 2
        uses: ./
        with:
          output-path: ./test-output/header-level.md
          header-level: "2"

      - name: Validate header levels
        run: |
          file="./test-output/header-level.md"

          # Title should be H2 (##)
          if ! grep -q "^## Action Docs Generator" "$file"; then
            echo "::error::Title should be H2"
            exit 1
          fi

          # Subsections should be H3 (###)
          if ! grep -q "^### Inputs" "$file"; then
            echo "::error::Inputs should be H3"
            exit 1
          fi

          echo "Header level adjustment working correctly"

  test-custom-template:
    name: Test custom template
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create output and fixtures directories
        run: mkdir -p ./test-output ./test-fixtures

      - name: Create custom template
        run: |
          cat > ./test-fixtures/custom.hbs << 'EOF'
          # {{action.name}}

          > Custom template test

          {{action.description}}

          ## Available Inputs

          {{#each action.inputs}}
          - **{{this.id}}**: {{this.description}}
          {{/each}}
          EOF

      - name: Generate README with custom template
        uses: ./
        with:
          output-path: ./test-output/custom-template.md
          template-path: ./test-fixtures/custom.hbs

      - name: Validate custom template used
        run: |
          file="./test-output/custom-template.md"

          if ! grep -q "Custom template test" "$file"; then
            echo "::error::Custom template not used"
            exit 1
          fi

          if ! grep -q "Available Inputs" "$file"; then
            echo "::error::Custom section header not found"
            exit 1
          fi

          # Default sections should NOT be present
          if grep -q "^## Requirements" "$file"; then
            echo "::error::Default template sections should not appear"
            exit 1
          fi

          echo "Custom template working correctly"

  test-contributing-url:
    name: Test contributing URL
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create output directory
        run: mkdir -p ./test-output

      - name: Generate README with contributing URL
        uses: ./
        with:
          output-path: ./test-output/contributing.md
          contributing-url: https://github.com/freerangebytes/action-docs-generator/CONTRIBUTING.md

      - name: Validate contributing link
        run: |
          file="./test-output/contributing.md"

          if ! grep -q "CONTRIBUTING.md" "$file"; then
            echo "::error::Contributing link not found"
            exit 1
          fi

          if ! grep -q "freerangebytes" "$file"; then
            echo "::error::Contributing URL incorrect"
            exit 1
          fi

          echo "Contributing URL working correctly"

  test-action-yml:
    name: Test action.yml extension
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create output and fixtures directories
        run: mkdir -p ./test-output ./test-fixtures

      - name: Create action.yml test file
        run: |
          cat > ./test-fixtures/action.yml << 'EOF'
          name: Test Action YML
          description: Testing .yml extension support
          inputs:
            test-input:
              description: A test input
              required: true
          outputs:
            test-output:
              description: A test output
          runs:
            using: node24
            main: index.js
          EOF

      - name: Generate README from action.yml
        uses: ./
        with:
          action-path: ./test-fixtures/action.yml
          output-path: ./test-output/yml-extension.md

      - name: Validate output
        run: |
          file="./test-output/yml-extension.md"

          if ! grep -q "Test Action YML" "$file"; then
            echo "::error::Action name not found"
            exit 1
          fi

          if ! grep -q "test-input" "$file"; then
            echo "::error::Input not found"
            exit 1
          fi

          echo ".yml extension support working correctly"

  test-required-inputs:
    name: Test required inputs display
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create output and fixtures directories
        run: mkdir -p ./test-output ./test-fixtures

      - name: Create action with required inputs
        run: |
          cat > ./test-fixtures/required-action.yaml << 'EOF'
          name: Action With Required Inputs
          description: Testing required inputs display
          inputs:
            required-input:
              description: This input is required
              required: true
            optional-input:
              description: This input is optional
              required: false
              default: 'default-value'
          runs:
            using: node24
            main: index.js
          EOF

      - name: Generate README
        uses: ./
        with:
          action-path: ./test-fixtures/required-action.yaml
          output-path: ./test-output/required-inputs.md

      - name: Validate required inputs shown in usage
        run: |
          file="./test-output/required-inputs.md"

          # Usage section should have with: block (not commented) because there's a required input
          # Look for the pattern in the usage code block
          if ! grep -A5 "^## Usage" "$file" | grep -q "with:"; then
            echo "::error::with: should be present for required inputs"
            exit 1
          fi

          # Required input should be shown
          if ! grep -q "required-input:" "$file"; then
            echo "::error::Required input not in usage"
            exit 1
          fi

          echo "Required inputs display working correctly"

  test-custom-examples:
    name: Test custom examples from file
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create output and fixtures directories
        run: mkdir -p ./test-output ./test-fixtures

      - name: Create examples file
        run: |
          cat > ./test-fixtures/examples.yaml << 'EOF'
          examples:
            - title: Example One
              description: First example description

            - title: Example Two
              description: Second example description
              with:
                action-path: ./custom/action.yaml
          EOF

      - name: Generate README with custom examples
        uses: ./
        with:
          output-path: ./test-output/custom-examples.md
          examples-path: ./test-fixtures/examples.yaml

      - name: Validate custom examples present
        run: |
          file="./test-output/custom-examples.md"

          # Check that custom example titles are present
          if ! grep -q "### Example One" "$file"; then
            echo "::error::Example One title not found"
            exit 1
          fi

          if ! grep -q "### Example Two" "$file"; then
            echo "::error::Example Two title not found"
            exit 1
          fi

          # Check that descriptions are present
          if ! grep -q "First example description" "$file"; then
            echo "::error::Example One description not found"
            exit 1
          fi

          if ! grep -q "Second example description" "$file"; then
            echo "::error::Example Two description not found"
            exit 1
          fi

          # Check that generated code is present (uses repositoryUrl from context)
          pattern="uses: freerangebytes/action-docs-generator@"
          if ! grep -q "$pattern" "$file"; then
            echo "::error::Example code not found"
            exit 1
          fi

          # Check that Example Two has with block
          if ! grep -q "action-path:" "$file"; then
            echo "::error::Example Two with block not found"
            exit 1
          fi

          # Default "Basic Usage" example should NOT be present when custom examples are provided
          if grep -q "### Basic Usage" "$file"; then
            echo "::error::Default Basic Usage should not appear when custom examples are provided"
            exit 1
          fi

          echo "Custom examples working correctly"

  test-description-override:
    name: Test description override
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create output directory
        run: mkdir -p ./test-output

      - name: Generate README with custom description
        uses: ./
        with:
          output-path: ./test-output/description-override.md
          description: |
            This is a custom description that overrides the one from action.yaml.

            It supports **markdown** formatting and multiple paragraphs.

      - name: Validate custom description used
        run: |
          file="./test-output/description-override.md"

          # Custom description should be present
          if ! grep -q "This is a custom description" "$file"; then
            echo "::error::Custom description not found"
            exit 1
          fi

          if ! grep -q "overrides the one from action.yaml" "$file"; then
            echo "::error::Custom description text incomplete"
            exit 1
          fi

          # Original description should NOT be present
          if grep -q "Generates comprehensive README documentation from action.yaml metadata files" "$file"; then
            echo "::error::Original description should be overridden"
            exit 1
          fi

          echo "Description override working correctly"

  test-description-path:
    name: Test description from file
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create output and fixtures directories
        run: mkdir -p ./test-output ./test-fixtures

      - name: Create description markdown file
        run: |
          cat > ./test-fixtures/DESCRIPTION.md << 'EOF'
          This description is loaded from a markdown file.

          ## Features

          - Feature one
          - Feature two
          - Feature three

          This allows for more complex descriptions with full markdown support.
          EOF

      - name: Generate README with description from file
        uses: ./
        with:
          output-path: ./test-output/description-path.md
          description-path: ./test-fixtures/DESCRIPTION.md

      - name: Validate description from file used
        run: |
          file="./test-output/description-path.md"

          # Description from file should be present
          if ! grep -q "This description is loaded from a markdown file" "$file"; then
            echo "::error::Description from file not found"
            exit 1
          fi

          if ! grep -q "Feature one" "$file"; then
            echo "::error::Feature list not found"
            exit 1
          fi

          # Original description should NOT be present
          if grep -q "Generates comprehensive README documentation from action.yaml metadata files" "$file"; then
            echo "::error::Original description should be overridden"
            exit 1
          fi

          echo "Description path working correctly"

  test-description-path-priority:
    name: Test description-path takes priority over description
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Create output and fixtures directories
        run: mkdir -p ./test-output ./test-fixtures

      - name: Create description markdown file
        run: |
          cat > ./test-fixtures/priority-description.md << 'EOF'
          This is the description from the file and should take priority.
          EOF

      - name: Generate README with both description and description-path
        uses: ./
        with:
          output-path: ./test-output/description-priority.md
          description: This is the direct description and should be ignored.
          description-path: ./test-fixtures/priority-description.md

      - name: Validate description-path takes priority
        run: |
          file="./test-output/description-priority.md"

          # Description from file should be present (takes priority)
          if ! grep -q "description from the file and should take priority" "$file"; then
            echo "::error::Description from file not found"
            exit 1
          fi

          # Direct description should NOT be present
          if grep -q "This is the direct description and should be ignored" "$file"; then
            echo "::error::Direct description should be ignored when description-path is provided"
            exit 1
          fi

          echo "Description path priority working correctly"
